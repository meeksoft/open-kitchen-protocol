#!/usr/bin/env python3
"""
OKP Validator - Validate Open Kitchen Protocol configuration files.

Usage:
    okp-validate <file>           Validate a single file
    okp-validate <file1> <file2>  Validate multiple files
    okp-validate --init           Create a starter template
    okp-validate --help           Show this help

Examples:
    okp-validate open-kitchen.yaml
    okp-validate examples/*.yaml
    okp-validate --init > my-kitchen.yaml
"""

import sys
import json
import os
from pathlib import Path

# Try to import optional dependencies
try:
    import yaml
    HAS_YAML = True
except ImportError:
    HAS_YAML = False

try:
    import jsonschema
    HAS_JSONSCHEMA = True
except ImportError:
    HAS_JSONSCHEMA = False


STARTER_TEMPLATE = """\
# Open Kitchen Protocol Configuration
# https://github.com/dimmoro/open-kitchen-protocol
okp: "1.0"

# Define your AI agents
agents:
  - id: planner
    provider: anthropic
    model: claude-sonnet-4-20250514
    role: planning
    capabilities:
      - task_decomposition
      - architecture_design

  - id: coder
    provider: openai
    model: gpt-4
    role: implementation
    capabilities:
      - code_generation
      - debugging

  - id: reviewer
    provider: anthropic
    model: claude-sonnet-4-20250514
    role: review
    capabilities:
      - code_review
      - security_audit

# Define how tasks flow between agents
workflow:
  - id: plan
    agent: planner
    action: decompose
    outputs: [plan, subtasks]

  - id: implement
    agent: coder
    depends_on: [plan]
    action: execute
    outputs: [code, tests]

  - id: review
    agent: reviewer
    depends_on: [implement]
    action: review
    outputs: [feedback]

# Define how context transfers between agents
handoff:
  mode: auto
  require_context: true
  context_fields:
    - task_description
    - acceptance_criteria
    - previous_output

# Optional: Task backend integration
tasks:
  backend: beads
  project_prefix: MY-PROJECT
"""


def get_schema_path():
    """Find the schema file relative to this script."""
    script_dir = Path(__file__).parent.parent
    schema_path = script_dir / "schemas" / "okp.schema.json"
    if schema_path.exists():
        return schema_path
    # Fallback: check current directory
    if Path("schemas/okp.schema.json").exists():
        return Path("schemas/okp.schema.json")
    return None


def load_schema():
    """Load the OKP JSON schema."""
    schema_path = get_schema_path()
    if not schema_path:
        print("Error: Cannot find okp.schema.json", file=sys.stderr)
        print("Make sure you're running from the OKP repo or schema is in ./schemas/", file=sys.stderr)
        sys.exit(1)
    with open(schema_path) as f:
        return json.load(f)


def validate_file(filepath, schema):
    """Validate a single OKP file against the schema."""
    filepath = Path(filepath)
    
    if not filepath.exists():
        return False, f"File not found: {filepath}"
    
    try:
        with open(filepath) as f:
            content = f.read()
    except Exception as e:
        return False, f"Cannot read file: {e}"
    
    # Parse YAML or JSON
    try:
        if filepath.suffix in ['.yaml', '.yml']:
            if not HAS_YAML:
                return False, "PyYAML not installed. Run: pip install pyyaml"
            doc = yaml.safe_load(content)
        else:
            doc = json.loads(content)
    except Exception as e:
        return False, f"Parse error: {e}"
    
    if doc is None:
        return False, "Empty document"
    
    # Validate against schema
    if not HAS_JSONSCHEMA:
        # Basic validation without jsonschema
        if 'okp' not in doc:
            return False, "Missing required field: 'okp' (version)"
        if 'agents' not in doc:
            return False, "Missing required field: 'agents'"
        return True, "Valid (basic check - install jsonschema for full validation)"
    
    try:
        jsonschema.validate(doc, schema)
        return True, "Valid"
    except jsonschema.ValidationError as e:
        return False, f"Validation error: {e.message}"


def print_help():
    """Print help message."""
    print(__doc__)


def main():
    args = sys.argv[1:]
    
    if not args or '--help' in args or '-h' in args:
        print_help()
        sys.exit(0)
    
    if '--init' in args:
        print(STARTER_TEMPLATE)
        sys.exit(0)
    
    # Load schema once
    schema = load_schema()
    
    # Validate each file
    all_valid = True
    for filepath in args:
        valid, message = validate_file(filepath, schema)
        status = "✅" if valid else "❌"
        print(f"{status} {filepath}: {message}")
        if not valid:
            all_valid = False
    
    sys.exit(0 if all_valid else 1)


if __name__ == "__main__":
    main()
